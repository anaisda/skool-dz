// Multi-language translations - Pure content for each language
const translations = {
    en: {
        'nav.home': 'Home',
        'nav.courses': 'Courses',
        'nav.features': 'Features',
        'nav.about': 'About',
        'badge.trusted': '✨ Trusted platform for 500+ students',
        'hero.title1': 'Join us today',
        'hero.title2': 'Transform your future',
        'hero.subtitle': 'An academic excellence platform designed for Algerian high school students. Top-quality courses, expert teachers, and personalized support.',
        'hero.explore': 'Explore courses',
        'hero.learn': 'Discover features',
        'reasons.badge': 'Why choose Skool DZ',
        'reasons.title': 'Reasons for your success',
        'reasons.reason1': 'Excellence professors',
        'reasons.desc1': 'Years of experience and passion for teaching',
        'reasons.reason2': 'Absolute mastery',
        'reasons.desc2': 'Experts in every subject taught',
        'reasons.reason3': 'Dedicated to your success',
        'reasons.desc3': 'Personalized support for each student',
        'reasons.reason4': 'Innovative methods',
        'reasons.desc4': 'Research-based teaching approaches',
        'reasons.reason5': '512 progressive exercises',
        'reasons.desc5': 'Intensive training for rapid progress',
        'stats.students': 'Active students',
        'stats.success': 'Success rate',
        'stats.courses': 'Available courses',
        'courses.badge': 'Our programs',
        'courses.title': 'Available courses',
        'courses.subtitle': 'Courses adapted to all Algerian baccalaureate branches',
        'filter.all': 'All branches',
        'filter.sciences': 'Exp. Sciences',
        'filter.math': 'Mathematics',
        'filter.lettres': 'Letters & Philosophy',
        'filter.gestion': 'Management & Economics',
        'course.register': 'Register now',
        'features.badge': 'What we offer',
        'features.title': 'Premium features',
        'features.community': 'Active community',
        'features.communityText': 'Join study groups and get personalized progress tracking',
        'features.zoom': 'Live Zoom sessions',
        'features.zoomText': 'Exclusive 1-on-1 courses with our best teachers',
        'features.recorded': 'Complete library',
        'features.recordedText': 'Unlimited access to all recorded courses',
        'features.plans': 'Personalized plans',
        'features.plansText': 'A schedule adapted to your academic goals',
        'features.time': 'Time management',
        'features.timeText': 'Optimize your organization to maximize results',
        'features.more': 'And much more...',
        'features.moreText': 'Tools and resources to guide you to excellence',
        'about.badge': 'About us',
        'about.title': 'Excellence at the service of your success',
        'about.description': 'Skool DZ was born from a vision: democratizing access to quality education for all Algerian high school students. We combine pedagogical expertise, modern technology and personalized support to help you achieve your academic goals and realize your potential.',
        'about.feature1': 'Certified and experienced teachers',
        'about.feature2': 'Platform accessible 24/7',
        'about.feature3': 'Personalized progress tracking',
        'about.discover': 'Discover our courses',
        'register.title': 'Course registration',
        'register.subtitle': 'Complete this form to join the course',
        'register.fullName': 'Full name',
        'register.contact': 'Contact',
        'register.receipt': 'Payment receipt',
        'register.chooseFile': 'Choose a file',
        'register.paymentInfo': 'Payment information:',
        'register.submit': 'Confirm registration',
        'success.registration': 'Registration submitted successfully!',
        'error.registration': 'Error submitting registration. Please try again.',
        'error.general': 'An error occurred. Please try again.'
    },
    fr: {
        'nav.home': 'Accueil',
        'nav.courses': 'Cours',
        'nav.features': 'Fonctionnalités',
        'nav.about': 'À propos',
        'badge.trusted': '✨ Plateforme de confiance pour plus de 500+ élèves',
        'hero.title1': 'Rejoins-nous dès aujourd\'hui',
        'hero.title2': 'Transforme ton avenir',
        'hero.subtitle': 'Une plateforme d\'excellence académique conçue pour les lycéens algériens. Des cours de qualité supérieure, des professeurs experts, et un accompagnement personnalisé.',
        'hero.explore': 'Explorer les cours',
        'hero.learn': 'Découvrir les fonctionnalités',
        'reasons.badge': 'Pourquoi choisir Skool DZ',
        'reasons.title': 'Les raisons de ton succès',
        'reasons.reason1': 'Professeurs d\'excellence',
        'reasons.desc1': 'Des années d\'expérience et une passion pour l\'enseignement',
        'reasons.reason2': 'Maîtrise absolue',
        'reasons.desc2': 'Des experts dans chaque matière enseignée',
        'reasons.reason3': 'Dévoués à ta réussite',
        'reasons.desc3': 'Un accompagnement personnalisé pour chaque élève',
        'reasons.reason4': 'Méthodes innovantes',
        'reasons.desc4': 'Approches pédagogiques basées sur la recherche',
        'reasons.reason5': '512 exercices progressifs',
        'reasons.desc5': 'Un entraînement intensif pour des progrès rapides',
        'stats.students': 'Élèves actifs',
        'stats.success': 'Taux de réussite',
        'stats.courses': 'Cours disponibles',
        'courses.badge': 'Nos programmes',
        'courses.title': 'Cours disponibles',
        'courses.subtitle': 'Des cours adaptés à toutes les filières du baccalauréat algérien',
        'filter.all': 'Toutes les filières',
        'filter.sciences': 'Sciences Exp.',
        'filter.math': 'Mathématiques',
        'filter.lettres': 'Lettres & Philosophie',
        'filter.gestion': 'Gestion & Économie',
        'course.register': 'S\'inscrire maintenant',
        'features.badge': 'Ce que nous offrons',
        'features.title': 'Fonctionnalités premium',
        'features.community': 'Communauté active',
        'features.communityText': 'Rejoins des groupes d\'étude et bénéficie d\'un suivi personnalisé',
        'features.zoom': 'Sessions Zoom en direct',
        'features.zoomText': 'Des cours exclusifs en tête-à-tête avec nos meilleurs professeurs',
        'features.recorded': 'Bibliothèque complète',
        'features.recordedText': 'Accès illimité à tous les cours enregistrés',
        'features.plans': 'Plans personnalisés',
        'features.plansText': 'Un programme adapté à tes objectifs académiques',
        'features.time': 'Gestion du temps',
        'features.timeText': 'Optimise ton organisation pour maximiser tes résultats',
        'features.more': 'Et bien plus encore...',
        'features.moreText': 'Des outils et ressources pour t\'accompagner vers l\'excellence',
        'about.badge': 'À propos de nous',
        'about.title': 'L\'excellence au service de ta réussite',
        'about.description': 'Skool DZ est né d\'une vision : démocratiser l\'accès à une éducation de qualité pour tous les lycéens algériens. Nous combinons l\'expertise pédagogique, la technologie moderne et un accompagnement personnalisé pour t\'aider à atteindre tes objectifs académiques et réaliser ton potentiel.',
        'about.feature1': 'Professeurs certifiés et expérimentés',
        'about.feature2': 'Plateforme accessible 24/7',
        'about.feature3': 'Suivi personnalisé de progression',
        'about.discover': 'Découvrir nos cours',
        'register.title': 'Inscription au cours',
        'register.subtitle': 'Complète ce formulaire pour rejoindre le cours',
        'register.fullName': 'Nom complet',
        'register.contact': 'Contact',
        'register.receipt': 'Reçu de paiement',
        'register.chooseFile': 'Choisir un fichier',
        'register.paymentInfo': 'Informations de paiement :',
        'register.submit': 'Confirmer l\'inscription',
        'success.registration': 'Inscription soumise avec succès !',
        'error.registration': 'Erreur lors de l\'envoi de l\'inscription. Veuillez réessayer.',
        'error.general': 'Une erreur s\'est produite. Veuillez réessayer.'
    },
    ar: {
        'nav.home': 'الرئيسية',
        'nav.courses': 'الدورات',
        'nav.features': 'المميزات',
        'nav.about': 'من نحن',
        'badge.trusted': '✨ منصة موثوقة لأكثر من 500+ طالب',
        'hero.title1': 'انضم إلينا اليوم',
        'hero.title2': 'حوّل مستقبلك',
        'hero.subtitle': 'منصة تميّز أكاديمي مصممة لطلاب الثانوية الجزائريين. دورات عالية الجودة، أساتذة خبراء، ودعم شخصي.',
        'hero.explore': 'استكشف الدورات',
        'hero.learn': 'اكتشف المميزات',
        'reasons.badge': 'لماذا تختار Skool DZ',
        'reasons.title': 'أسباب نجاحك',
        'reasons.reason1': 'أساتذة متميزون',
        'reasons.desc1': 'سنوات من الخبرة والشغف بالتعليم',
        'reasons.reason2': 'إتقان مطلق',
        'reasons.desc2': 'خبراء في كل مادة',
        'reasons.reason3': 'مكرسون لنجاحك',
        'reasons.desc3': 'دعم شخصي لكل طالب',
        'reasons.reason4': 'طرق مبتكرة',
        'reasons.desc4': 'أساليب تعليمية قائمة على البحث',
        'reasons.reason5': '512 تمرين تدريجي',
        'reasons.desc5': 'تدريب مكثف لتحقيق تقدم سريع',
        'stats.students': 'طلاب نشطون',
        'stats.success': 'معدل النجاح',
        'stats.courses': 'دورات متاحة',
        'courses.badge': 'برامجنا',
        'courses.title': 'الدورات المتاحة',
        'courses.subtitle': 'دورات مصممة لجميع شعب البكالوريا الجزائرية',
        'filter.all': 'جميع الشعب',
        'filter.sciences': 'علوم تجريبية',
        'filter.math': 'رياضيات',
        'filter.lettres': 'آداب وفلسفة',
        'filter.gestion': 'إدارة واقتصاد',
        'course.register': 'سجّل الآن',
        'features.badge': 'ما نقدمه',
        'features.title': 'مميزات مميزة',
        'features.community': 'مجتمع نشط',
        'features.communityText': 'انضم إلى مجموعات الدراسة واحصل على متابعة شخصية',
        'features.zoom': 'جلسات Zoom مباشرة',
        'features.zoomText': 'دورات حصرية فردية مع أفضل أساتذتنا',
        'features.recorded': 'مكتبة كاملة',
        'features.recordedText': 'وصول غير محدود لجميع الدورات المسجلة',
        'features.plans': 'خطط شخصية',
        'features.plansText': 'برنامج مصمم حسب أهدافك الأكاديمية',
        'features.time': 'إدارة الوقت',
        'features.timeText': 'حسّن تنظيمك لتحقيق أقصى النتائج',
        'features.more': 'والمزيد...',
        'features.moreText': 'أدوات وموارد لإرشادك نحو التميز',
        'about.badge': 'من نحن',
        'about.title': 'التميز في خدمة نجاحك',
        'about.description': 'وُلدت Skool DZ من رؤية: إتاحة الوصول إلى تعليم عالي الجودة لجميع طلاب الثانوية الجزائريين. نجمع بين الخبرة التربوية والتكنولوجيا الحديثة والدعم الشخصي لمساعدتك على تحقيق أهدافك الأكاديمية وإطلاق إمكاناتك.',
        'about.feature1': 'أساتذة معتمدون وذوو خبرة',
        'about.feature2': 'منصة متاحة 24/7',
        'about.feature3': 'متابعة شخصية للتقدم',
        'about.discover': 'اكتشف دوراتنا',
        'register.title': 'التسجيل في الدورة',
        'register.subtitle': 'أكمل هذا النموذج للانضمام إلى الدورة',
        'register.fullName': 'الاسم الكامل',
        'register.contact': 'جهة الاتصال',
        'register.receipt': 'إيصال الدفع',
        'register.chooseFile': 'اختر ملفًا',
        'register.paymentInfo': 'معلومات الدفع:',
        'register.submit': 'تأكيد التسجيل',
        'success.registration': 'تم إرسال التسجيل بنجاح!',
        'error.registration': 'خطأ في إرسال التسجيل. يرجى المحاولة مرة أخرى.',
        'error.general': 'حدث خطأ. يرجى المحاولة مرة أخرى.'
    }
};

// Global state
let currentLang = localStorage.getItem('language') || 'fr';
let currentSection = 'home';
let currentFilter = 'all';
let courses = [];

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    loadCourses();
    setupLanguageSwitcher();
    setupNavigation();
    setupMobileMenu();
    setupFilterTabs();
    setupFileUpload();
    applyTranslations();
    updateDirection();
});

// Mobile Menu Toggle
function setupMobileMenu() {
    const menuToggle = document.querySelector('.menu-toggle');
    const navMenu = document.querySelector('.nav-menu');
    const navLinks = document.querySelectorAll('.nav-link');
    
    if (!menuToggle || !navMenu) return;
    
    // Toggle menu on hamburger click
    menuToggle.addEventListener('click', (e) => {
        e.stopPropagation();
        menuToggle.classList.toggle('active');
        navMenu.classList.toggle('active');
        
        // Prevent body scroll when menu is open
        if (navMenu.classList.contains('active')) {
            document.body.style.overflow = 'hidden';
        } else {
            document.body.style.overflow = '';
        }
    });
    
    // Close menu when clicking on nav links
    navLinks.forEach(link => {
        link.addEventListener('click', () => {
            menuToggle.classList.remove('active');
            navMenu.classList.remove('active');
            document.body.style.overflow = '';
        });
    });
    
    // Close menu when clicking outside
    document.addEventListener('click', (e) => {
        if (!navMenu.contains(e.target) && !menuToggle.contains(e.target)) {
            menuToggle.classList.remove('active');
            navMenu.classList.remove('active');
            document.body.style.overflow = '';
        }
    });
    
    // Close menu on window resize if it's open
    let resizeTimer;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => {
            if (window.innerWidth > 768) {
                menuToggle.classList.remove('active');
                navMenu.classList.remove('active');
                document.body.style.overflow = '';
            }
        }, 250);
    });
}

// Language switcher
function setupLanguageSwitcher() {
    const dropdown = document.getElementById('lang-dropdown');
    const currentBtn = document.getElementById('lang-current');
    const currentText = document.getElementById('current-lang-text');
    const langBtns = document.querySelectorAll('.lang-btn');
    
    if (!dropdown || !currentBtn || !currentText) return;
    
    // Language display names
    const langNames = {
        'en': 'EN',
        'fr': 'FR',
        'ar': 'عر'
    };
    
    // Set initial active button and text
    langBtns.forEach(btn => {
        if (btn.dataset.lang === currentLang) {
            btn.classList.add('active');
            currentText.textContent = langNames[currentLang];
        }
    });
    
    // Toggle dropdown
    currentBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        dropdown.classList.toggle('active');
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', () => {
        dropdown.classList.remove('active');
    });
    
    // Handle language selection
    langBtns.forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            
            currentLang = btn.dataset.lang;
            localStorage.setItem('language', currentLang);
            
            // Update active state
            langBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            // Update current text
            currentText.textContent = langNames[currentLang];
            
            // Close dropdown
            dropdown.classList.remove('active');
            
            // Apply translations and update direction
            applyTranslations();
            updateDirection();
            renderCourses(); // Re-render courses with new language
        });
    });
}

// Apply translations to all elements with data-translate
function applyTranslations() {
    const elements = document.querySelectorAll('[data-translate]');
    elements.forEach(element => {
        const key = element.getAttribute('data-translate');
        const translation = translations[currentLang][key];
        
        if (translation) {
            // Update text content or placeholder
            if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                if (element.hasAttribute('placeholder')) {
                    element.placeholder = translation;
                }
            } else {
                element.textContent = translation;
            }
        }
    });
}

// Update direction for Arabic
function updateDirection() {
    if (currentLang === 'ar') {
        document.documentElement.setAttribute('dir', 'rtl');
        document.documentElement.setAttribute('lang', 'ar');
    } else {
        document.documentElement.setAttribute('dir', 'ltr');
        document.documentElement.setAttribute('lang', currentLang);
    }
}

// Navigation
function setupNavigation() {
    const navLinks = document.querySelectorAll('.nav-link');
    navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const sectionId = link.getAttribute('href').substring(1);
            showSection(sectionId);
        });
    });
}

function showSection(sectionId) {
    currentSection = sectionId;
    
    document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
    });
    
    document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
    });
    
    const targetSection = document.getElementById(sectionId);
    if (targetSection) {
        targetSection.classList.add('active');
    }
    
    const targetLink = document.querySelector(`.nav-link[href="#${sectionId}"]`);
    if (targetLink) {
        targetLink.classList.add('active');
    }
    
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Filter tabs
function setupFilterTabs() {
    const filterBtns = document.querySelectorAll('.pill-btn');
    filterBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            currentFilter = btn.dataset.filter;
            
            filterBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            renderCourses();
        });
    });
}

// File upload
function setupFileUpload() {
    const fileInput = document.getElementById('reg-receipt');
    const fileName = document.getElementById('file-name');
    
    if (fileInput && fileName) {
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                fileName.textContent = e.target.files[0].name;
            } else {
                fileName.textContent = translations[currentLang]['register.chooseFile'];
            }
        });
    }
}

// Load courses
async function loadCourses() {
    try {
        const response = await fetch('/api/courses');
        if (response.ok) {
            courses = await response.json();
            renderCourses();
        }
    } catch (error) {
        console.error('Error loading courses:', error);
    }
}

// Render courses
function renderCourses() {
    const container = document.querySelector('.courses-grid-modern');
    if (!container) return;
    
    const filteredCourses = currentFilter === 'all' 
        ? courses 
        : courses.filter(course => course.branch === currentFilter);
    
    if (filteredCourses.length === 0) {
        container.innerHTML = `
            <div style="grid-column: 1/-1; text-align: center; padding: 4rem; color: var(--gray-500);">
                <p style="font-size: 1.125rem;">Aucun cours disponible pour cette filière</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = filteredCourses.map(course => {
        const branchNames = {
            'sciences': { fr: 'Sciences Exp.', ar: 'علوم تجريبية', en: 'Exp. Sciences' },
            'math': { fr: 'Mathématiques', ar: 'رياضيات', en: 'Mathematics' },
            'technique': { fr: 'Tech. Math', ar: 'تقني رياضي', en: 'Tech. Math' },
            'gestion': { fr: 'Gestion', ar: 'تسيير', en: 'Management' },
            'lettres': { fr: 'Lettres', ar: 'آداب', en: 'Letters' },
            'all': { fr: 'Toutes', ar: 'الكل', en: 'All' }
        };
        
        const courseName = course[`name_${currentLang}`] || course.name_fr;
        const courseDesc = course[`description_${currentLang}`] || course.description_fr;
        const branchName = branchNames[course.branch]?.[currentLang] || course.branch;
        
        return `
            <div class="course-card-modern">
                <div class="course-image-modern">
                    ${course.image_url ? 
                        `<img src="${course.image_url}" alt="${courseName}" loading="lazy">` : 
                        '<div style="background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-500) 100%); height: 100%;"></div>'
                    }
                    <div class="course-badge-modern">${branchName}</div>
                </div>
                <div class="course-content-modern">
                    <h3 class="course-title-modern">${courseName}</h3>
                    ${courseDesc ? `<p class="course-description-modern">${courseDesc}</p>` : ''}
                    <div class="course-footer-modern">
                        <div class="course-price-modern">${course.price.toLocaleString()} DZD</div>
                        <button class="btn-enroll" onclick="openRegistration(${course.id})" data-translate="course.register">
                            ${translations[currentLang]['course.register']}
                        </button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// Registration modal
function openRegistration(courseId) {
    const modal = document.getElementById('registration-modal');
    document.getElementById('reg-course-id').value = courseId;
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeRegistrationModal() {
    const modal = document.getElementById('registration-modal');
    modal.classList.remove('active');
    document.getElementById('registration-form').reset();
    document.getElementById('file-name').textContent = translations[currentLang]['register.chooseFile'];
    document.body.style.overflow = '';
}

// Handle registration form
document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('registration-form');
    if (form) {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData();
            formData.append('course_id', document.getElementById('reg-course-id').value);
            formData.append('full_name', document.getElementById('reg-fullname').value);
            formData.append('contact', document.getElementById('reg-contact').value);
            formData.append('receipt', document.getElementById('reg-receipt').files[0]);
            
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span>⏳ Envoi en cours...</span>';
            
            try {
                const response = await fetch('/api/registrations', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert(translations[currentLang]['success.registration']);
                    closeRegistrationModal();
                } else {
                    alert(data.error || translations[currentLang]['error.registration']);
                }
            } catch (error) {
                console.error('Registration error:', error);
                alert(translations[currentLang]['error.general']);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });
    }
});

// Close modal when clicking overlay
document.addEventListener('click', (e) => {
    if (e.target.classList.contains('modal-overlay')) {
        closeRegistrationModal();
    }
});

// Close modal with Escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeRegistrationModal();
        
        // Also close mobile menu if open
        const menuToggle = document.querySelector('.menu-toggle');
        const navMenu = document.querySelector('.nav-menu');
        if (menuToggle && navMenu && navMenu.classList.contains('active')) {
            menuToggle.classList.remove('active');
            navMenu.classList.remove('active');
            document.body.style.overflow = '';
        }
    }
});
