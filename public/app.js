// Multi-language translations - Pure content for each language
const translations = {
    en: {
        'nav.home': 'Home',
        'nav.courses': 'Courses',
        'nav.features': 'Features',
        'nav.about': 'About',
        'badge.trusted': '✨ Trusted platform for 500+ students',
        'hero.title1': 'Join us today',
        'hero.title2': 'Transform your future',
        'hero.subtitle': 'An academic excellence platform designed for Algerian high school students. Top-quality courses, expert teachers, and personalized support.',
        'hero.explore': 'Explore courses',
        'hero.learn': 'Discover features',
        'reasons.badge': 'Why choose Skool DZ',
        'reasons.title': 'Reasons for your success',
        'reasons.reason1': 'Excellence professors',
        'reasons.desc1': 'Years of experience and passion for teaching',
        'reasons.reason2': 'Absolute mastery',
        'reasons.desc2': 'Experts in every subject taught',
        'reasons.reason3': 'Dedicated to your success',
        'reasons.desc3': 'Personalized support for each student',
        'reasons.reason4': 'Innovative methods',
        'reasons.desc4': 'Research-based teaching approaches',
        'reasons.reason5': '512 progressive exercises',
        'reasons.desc5': 'Intensive training for rapid progress',
        'stats.students': 'Active students',
        'stats.success': 'Success rate',
        'stats.courses': 'Available courses',
        'courses.badge': 'Our programs',
        'courses.title': 'Available courses',
        'courses.subtitle': 'Courses adapted to all Algerian baccalaureate branches',
        'filter.all': 'All branches',
        'filter.sciences': 'Exp. Sciences',
        'filter.math': 'Mathematics',
        'filter.lettres': 'Letters & Philosophy',
        'filter.gestion': 'Management & Economics',
        'course.register': 'Register now',
        'features.badge': 'What we offer',
        'features.title': 'Premium features',
        'features.community': 'Active community',
        'features.communityText': 'Join study groups and get personalized progress tracking',
        'features.zoom': 'Live Zoom sessions',
        'features.zoomText': 'Exclusive 1-on-1 courses with our best teachers',
        'features.recorded': 'Complete library',
        'features.recordedText': 'Unlimited access to all recorded courses',
        'features.plans': 'Personalized plans',
        'features.plansText': 'A schedule adapted to your academic goals',
        'features.time': 'Time management',
        'features.timeText': 'Optimize your organization to maximize results',
        'features.more': 'And much more...',
        'features.moreText': 'Tools and resources to guide you to excellence',
        'about.badge': 'About us',
        'about.title': 'Excellence at the service of your success',
        'about.description': 'Skool DZ was born from a vision: democratizing access to quality education for all Algerian high school students. We combine pedagogical expertise, modern technology and personalized support to help you achieve your academic goals and realize your potential.',
        'about.feature1': 'Certified and experienced teachers',
        'about.feature2': 'Platform accessible 24/7',
        'about.feature3': 'Personalized progress tracking',
        'about.discover': 'Discover our courses',
        'register.title': 'Course registration',
        'register.subtitle': 'Complete this form to join the course',
        'register.fullName': 'Full name',
        'register.contact': 'Contact',
        'register.receipt': 'Payment receipt',
        'register.chooseFile': 'Choose a file',
        'register.paymentInfo': 'Payment information:',
        'register.submit': 'Confirm registration',
        'success.registration': 'Registration submitted successfully!',
        'error.registration': 'Error submitting registration. Please try again.',
        'error.general': 'An error occurred. Please try again.'
    },
    fr: {
        'nav.home': 'Accueil',
        'nav.courses': 'Cours',
        'nav.features': 'Fonctionnalités',
        'nav.about': 'À propos',
        'badge.trusted': '✨ Plateforme de confiance pour plus de 500+ élèves',
        'hero.title1': 'Rejoins-nous dès aujourd\'hui',
        'hero.title2': 'Transforme ton avenir',
        'hero.subtitle': 'Une plateforme d\'excellence académique conçue pour les lycéens algériens. Des cours de qualité supérieure, des professeurs experts, et un accompagnement personnalisé.',
        'hero.explore': 'Explorer les cours',
        'hero.learn': 'Découvrir les fonctionnalités',
        'reasons.badge': 'Pourquoi choisir Skool DZ',
        'reasons.title': 'Les raisons de ton succès',
        'reasons.reason1': 'Professeurs d\'excellence',
        'reasons.desc1': 'Des années d\'expérience et une passion pour l\'enseignement',
        'reasons.reason2': 'Maîtrise absolue',
        'reasons.desc2': 'Des experts dans chaque matière enseignée',
        'reasons.reason3': 'Dévoués à ta réussite',
        'reasons.desc3': 'Un accompagnement personnalisé pour chaque élève',
        'reasons.reason4': 'Méthodes innovantes',
        'reasons.desc4': 'Approches pédagogiques basées sur la recherche',
        'reasons.reason5': '512 exercices progressifs',
        'reasons.desc5': 'Un entraînement intensif pour des progrès rapides',
        'stats.students': 'Élèves actifs',
        'stats.success': 'Taux de réussite',
        'stats.courses': 'Cours disponibles',
        'courses.badge': 'Nos programmes',
        'courses.title': 'Cours disponibles',
        'courses.subtitle': 'Des cours adaptés à toutes les filières du baccalauréat algérien',
        'filter.all': 'Toutes les filières',
        'filter.sciences': 'Sciences Exp.',
        'filter.math': 'Mathématiques',
        'filter.lettres': 'Lettres et Philosophie',
        'filter.gestion': 'Gestion et Économie',
        'course.register': 'S\'inscrire maintenant',
        'features.badge': 'Ce que nous offrons',
        'features.title': 'Fonctionnalités premium',
        'features.community': 'Communauté active',
        'features.communityText': 'Rejoins des groupes d\'étude et bénéficie d\'un suivi personnalisé de tes progrès',
        'features.zoom': 'Sessions Zoom en direct',
        'features.zoomText': 'Cours exclusifs 1-on-1 avec nos meilleurs professeurs',
        'features.recorded': 'Bibliothèque complète',
        'features.recordedText': 'Accès illimité à tous les cours enregistrés',
        'features.plans': 'Plans personnalisés',
        'features.plansText': 'Un planning adapté à tes objectifs académiques',
        'features.time': 'Gestion du temps',
        'features.timeText': 'Optimise ton organisation pour maximiser tes résultats',
        'features.more': 'Et bien plus encore...',
        'features.moreText': 'Des outils et ressources pour t\'accompagner vers l\'excellence',
        'about.badge': 'À propos de nous',
        'about.title': 'L\'excellence au service de ta réussite',
        'about.description': 'Skool DZ est né d\'une vision : démocratiser l\'accès à une éducation de qualité pour tous les lycéens algériens. Nous combinons l\'expertise pédagogique, la technologie moderne et un accompagnement personnalisé pour t\'aider à atteindre tes objectifs académiques et réaliser ton potentiel.',
        'about.feature1': 'Professeurs certifiés et expérimentés',
        'about.feature2': 'Plateforme accessible 24/7',
        'about.feature3': 'Suivi personnalisé de progression',
        'about.discover': 'Découvrir nos cours',
        'register.title': 'Inscription au cours',
        'register.subtitle': 'Complète ce formulaire pour rejoindre le cours',
        'register.fullName': 'Nom complet',
        'register.contact': 'Contact',
        'register.receipt': 'Reçu de paiement',
        'register.chooseFile': 'Choisir un fichier',
        'register.paymentInfo': 'Informations de paiement :',
        'register.submit': 'Confirmer l\'inscription',
        'success.registration': 'Inscription soumise avec succès !',
        'error.registration': 'Erreur lors de la soumission. Veuillez réessayer.',
        'error.general': 'Une erreur s\'est produite. Veuillez réessayer.'
    },
    ar: {
        'nav.home': 'الرئيسية',
        'nav.courses': 'الدروس',
        'nav.features': 'المميزات',
        'nav.about': 'معلومات',
        'badge.trusted': '✨ منصة موثوقة لأكثر من 500+ طالب',
        'hero.title1': 'انضم إلينا اليوم',
        'hero.title2': 'حوّل مستقبلك',
        'hero.subtitle': 'منصة تميز أكاديمي مصممة لطلاب الثانوية الجزائريين. دورات عالية الجودة، معلمون خبراء، ودعم شخصي.',
        'hero.explore': 'استكشف الدروس',
        'hero.learn': 'اكتشف المميزات',
        'reasons.badge': 'لماذا تختار Skool DZ',
        'reasons.title': 'أسباب نجاحك',
        'reasons.reason1': 'أساتذة متميزون',
        'reasons.desc1': 'سنوات من الخبرة والشغف بالتدريس',
        'reasons.reason2': 'إتقان تام',
        'reasons.desc2': 'خبراء في كل مادة يتم تدريسها',
        'reasons.reason3': 'مكرسون لنجاحك',
        'reasons.desc3': 'دعم شخصي لكل طالب',
        'reasons.reason4': 'أساليب مبتكرة',
        'reasons.desc4': 'مناهج تعليمية قائمة على البحث',
        'reasons.reason5': '512 تمرين متدرج',
        'reasons.desc5': 'تدريب مكثف لتحقيق تقدم سريع',
        'stats.students': 'طالب نشط',
        'stats.success': 'معدل النجاح',
        'stats.courses': 'دورة متاحة',
        'courses.badge': 'برامجنا',
        'courses.title': 'الدروس المتاحة',
        'courses.subtitle': 'دروس مخصصة لجميع شعب البكالوريا الجزائرية',
        'filter.all': 'جميع الشعب',
        'filter.sciences': 'علوم تجريبية',
        'filter.math': 'رياضيات',
        'filter.lettres': 'آداب وفلسفة',
        'filter.gestion': 'تسيير واقتصاد',
        'course.register': 'سجل الآن',
        'features.badge': 'ما نقدمه',
        'features.title': 'مميزات متميزة',
        'features.community': 'مجتمع نشط',
        'features.communityText': 'انضم إلى مجموعات الدراسة واحصل على متابعة شخصية لتقدمك',
        'features.zoom': 'جلسات Zoom مباشرة',
        'features.zoomText': 'دورات حصرية فردية مع أفضل معلمينا',
        'features.recorded': 'مكتبة كاملة',
        'features.recordedText': 'وصول غير محدود لجميع الدروس المسجلة',
        'features.plans': 'خطط شخصية',
        'features.plansText': 'جدول زمني مكيف مع أهدافك الأكاديمية',
        'features.time': 'إدارة الوقت',
        'features.timeText': 'حسّن تنظيمك لتحقيق أقصى النتائج',
        'features.more': 'والمزيد...',
        'features.moreText': 'أدوات وموارد لإرشادك نحو التميز',
        'about.badge': 'معلومات عنا',
        'about.title': 'التميز في خدمة نجاحك',
        'about.description': 'وُلدت Skool DZ من رؤية: إضفاء الطابع الديمقراطي على الوصول إلى التعليم الجيد لجميع طلاب الثانوية الجزائريين. نحن نجمع بين الخبرة التربوية والتكنولوجيا الحديثة والدعم الشخصي لمساعدتك على تحقيق أهدافك الأكاديمية وإطلاق إمكاناتك.',
        'about.feature1': 'معلمون معتمدون وذوو خبرة',
        'about.feature2': 'منصة متاحة 24/7',
        'about.feature3': 'متابعة شخصية للتقدم',
        'about.discover': 'اكتشف دوراتنا',
        'register.title': 'التسجيل في الدورة',
        'register.subtitle': 'أكمل هذا النموذج للانضمام إلى الدورة',
        'register.fullName': 'الاسم الكامل',
        'register.contact': 'جهة الاتصال',
        'register.receipt': 'إيصال الدفع',
        'register.chooseFile': 'اختر ملفًا',
        'register.paymentInfo': 'معلومات الدفع:',
        'register.submit': 'تأكيد التسجيل',
        'success.registration': 'تم إرسال التسجيل بنجاح!',
        'error.registration': 'خطأ في إرسال التسجيل. يرجى المحاولة مرة أخرى.',
        'error.general': 'حدث خطأ. يرجى المحاولة مرة أخرى.'
    }
};

// Global state
let currentLang = localStorage.getItem('language') || 'fr';
let currentSection = 'home';
let currentFilter = 'all';
let courses = [];

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    loadCourses();
    setupLanguageSwitcher();
    setupNavigation();
    setupFilterTabs();
    setupFileUpload();
    applyTranslations();
    updateDirection();
});

// Language switcher
function setupLanguageSwitcher() {
    const dropdown = document.getElementById('lang-dropdown');
    const currentBtn = document.getElementById('lang-current');
    const currentText = document.getElementById('current-lang-text');
    const langBtns = document.querySelectorAll('.lang-btn');
    
    // Language display names
    const langNames = {
        'en': 'EN',
        'fr': 'FR',
        'ar': 'عر'
    };
    
    // Set initial active button and text
    langBtns.forEach(btn => {
        if (btn.dataset.lang === currentLang) {
            btn.classList.add('active');
            currentText.textContent = langNames[currentLang];
        }
    });
    
    // Toggle dropdown
    currentBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        dropdown.classList.toggle('active');
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', () => {
        dropdown.classList.remove('active');
    });
    
    // Handle language selection
    langBtns.forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            
            currentLang = btn.dataset.lang;
            localStorage.setItem('language', currentLang);
            
            // Update active state
            langBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            // Update current text
            currentText.textContent = langNames[currentLang];
            
            // Close dropdown
            dropdown.classList.remove('active');
            
            // Apply translations and update direction
            applyTranslations();
            updateDirection();
            renderCourses(); // Re-render courses with new language
        });
    });
}

// Apply translations to all elements with data-translate
function applyTranslations() {
    const elements = document.querySelectorAll('[data-translate]');
    elements.forEach(element => {
        const key = element.getAttribute('data-translate');
        const translation = translations[currentLang][key];
        
        if (translation) {
            // Update text content or placeholder
            if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                if (element.hasAttribute('placeholder')) {
                    element.placeholder = translation;
                }
            } else {
                element.textContent = translation;
            }
        }
    });
}

// Update direction for Arabic
function updateDirection() {
    if (currentLang === 'ar') {
        document.documentElement.setAttribute('dir', 'rtl');
        document.documentElement.setAttribute('lang', 'ar');
    } else {
        document.documentElement.setAttribute('dir', 'ltr');
        document.documentElement.setAttribute('lang', currentLang);
    }
}

// Navigation
function setupNavigation() {
    const navLinks = document.querySelectorAll('.nav-link');
    navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const sectionId = link.getAttribute('href').substring(1);
            showSection(sectionId);
        });
    });
}

function showSection(sectionId) {
    currentSection = sectionId;
    
    document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
    });
    
    document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
    });
    
    const targetSection = document.getElementById(sectionId);
    if (targetSection) {
        targetSection.classList.add('active');
    }
    
    const targetLink = document.querySelector(`.nav-link[href="#${sectionId}"]`);
    if (targetLink) {
        targetLink.classList.add('active');
    }
    
    window.scrollTo(0, 0);
}

// Filter tabs
function setupFilterTabs() {
    const filterTabs = document.querySelectorAll('.pill-btn');
    filterTabs.forEach(tab => {
        tab.addEventListener('click', () => {
            currentFilter = tab.dataset.branch;
            filterTabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            renderCourses();
        });
    });
}

// File upload
function setupFileUpload() {
    const fileInput = document.getElementById('reg-receipt');
    if (fileInput) {
        fileInput.addEventListener('change', (e) => {
            const fileName = e.target.files[0]?.name || translations[currentLang]['register.chooseFile'];
            const fileNameSpan = document.getElementById('file-name');
            if (fileNameSpan) {
                fileNameSpan.textContent = fileName;
            }
        });
    }
}

// Load courses from API
async function loadCourses() {
    try {
        const response = await fetch('/api/courses');
        courses = await response.json();
        renderCourses();
    } catch (error) {
        console.error('Error loading courses:', error);
    }
}

function renderCourses() {
    const coursesGrid = document.getElementById('courses-grid');
    if (!coursesGrid) return;
    
    const filteredCourses = currentFilter === 'all' 
        ? courses 
        : courses.filter(course => course.branch === currentFilter || course.branch === 'all');
    
    if (filteredCourses.length === 0) {
        const noCoursesMsg = {
            'fr': 'Aucun cours disponible pour cette filière.',
            'ar': 'لا توجد دروس متاحة لهذه الشعبة.',
            'en': 'No courses available for this branch.'
        };
        
        coursesGrid.innerHTML = `
            <div style="grid-column: 1/-1; text-align: center; padding: 3rem;">
                <p style="font-size: 1.2rem; color: #666;">${noCoursesMsg[currentLang]}</p>
            </div>
        `;
        return;
    }
    
    coursesGrid.innerHTML = filteredCourses.map(course => {
        const courseName = currentLang === 'ar' ? course.name_ar : 
                          currentLang === 'fr' ? course.name_fr : course.name_en;
        const courseDesc = currentLang === 'ar' ? course.description_ar : 
                          currentLang === 'fr' ? course.description_fr : course.description_en;
        
        const branchNames = {
            'sciences': {
                'en': 'Exp. Sciences',
                'fr': 'Sciences Exp.',
                'ar': 'علوم تجريبية'
            },
            'math': {
                'en': 'Mathematics',
                'fr': 'Mathématiques',
                'ar': 'رياضيات'
            },
            'technique': {
                'en': 'Tech Math',
                'fr': 'Tech. Math',
                'ar': 'تقني رياضي'
            },
            'gestion': {
                'en': 'Management',
                'fr': 'Gestion',
                'ar': 'تسيير واقتصاد'
            },
            'lettres': {
                'en': 'Letters',
                'fr': 'Lettres',
                'ar': 'آداب وفلسفة'
            },
            'all': {
                'en': 'All',
                'fr': 'Toutes',
                'ar': 'جميع الشعب'
            }
        };
        
        const branchName = branchNames[course.branch]?.[currentLang] || course.branch;
        
        return `
            <div class="course-card-modern" onclick="openRegistrationModal(${course.id})">
                ${course.image_path ? 
                    `<img src="${course.image_path}" alt="${courseName}" class="course-image-modern">` :
                    '<div class="course-image-modern" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>'
                }
                <div class="course-content-modern">
                    <span class="course-badge-modern">${branchName}</span>
                    <h3 class="course-title-modern">${courseName}</h3>
                    ${courseDesc ? `<p class="course-description-modern">${courseDesc}</p>` : ''}
                    <div class="course-footer-modern">
                        <span class="course-price-modern">${course.price.toLocaleString()} DZD</span>
                        <button class="btn-course-modern">
                            ${translations[currentLang]['course.register']}
                        </button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// Registration modal
function openRegistrationModal(courseId) {
    const modal = document.getElementById('registration-modal');
    modal.classList.add('active');
    document.getElementById('reg-course-id').value = courseId;
    
    // Reset form
    document.getElementById('registration-form').reset();
    const fileNameSpan = document.getElementById('file-name');
    if (fileNameSpan) {
        fileNameSpan.textContent = translations[currentLang]['register.chooseFile'];
    }
}

function closeRegistrationModal() {
    document.getElementById('registration-modal').classList.remove('active');
}

// Handle registration form submission
const regForm = document.getElementById('registration-form');
if (regForm) {
    regForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = new FormData();
        formData.append('courseId', document.getElementById('reg-course-id').value);
        formData.append('fullName', document.getElementById('reg-fullname').value);
        formData.append('contact', document.getElementById('reg-contact').value);
        formData.append('receipt', document.getElementById('reg-receipt').files[0]);
        
        try {
            const response = await fetch('/api/registrations', {
                method: 'POST',
                body: formData
            });
            
            if (response.ok) {
                alert(translations[currentLang]['success.registration']);
                closeRegistrationModal();
            } else {
                alert(translations[currentLang]['error.registration']);
            }
        } catch (error) {
            console.error('Error:', error);
            alert(translations[currentLang]['error.general']);
        }
    });
}

// Close modal when clicking outside
document.querySelectorAll('.modal-modern').forEach(modal => {
    modal.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal-modern')) {
            modal.classList.remove('active');
        }
    });
});